function ObjectTracker(){this._lastId=0,this._objs={}}function BrowserTabs(){}function Browser(){BrowserBase.call(this),this.tabs=new BrowserTabs,this._tabTracker=new ObjectTracker,this._windowTracker=new ObjectTracker,safari.application.addEventListener("beforeNavigate",func.bind(this._onBeforeNavigate,this),!0),safari.application.addEventListener("navigate",func.bind(this._onNavigate,this),!0),safari.application.addEventListener("activate",func.bind(this._onActivate,this),!0),safari.application.addEventListener("open",func.bind(this._onOpen,this),!0),safari.application.addEventListener("close",func.bind(this._onClose,this),!0)}function BrowserWindow(t,e){this._window=t,this._id=e}function BrowserTab(t,e){this._tab=t,this._id=e}var utils=require("kango/utils"),func=utils.func,array=utils.array,object=utils.object;ObjectTracker.prototype={_geNextId:function(){return this._lastId++},add:function(t){var e=this.getId(t);return-1==e?(e=this._geNextId(),this._objs[e]=t,e):-1},remove:function(t){var e=this.getId(t);return-1!=e?delete this._objs[e]:!1},getId:function(t){for(var e in this._objs)if(this._objs.hasOwnProperty(e)&&this._objs[e]===t)return e;return-1}},BrowserTabs.prototype=object.extend(BrowserTabsBase,{getAll:function(t){for(var e=[],i=safari.application.browserWindows,r=0;r<i.length;r++)for(var a=i[r].tabs,n=0;n<a.length;n++)e.push(browser.getKangoTab(a[n]));t(e)},getCurrent:function(t){t(browser.getKangoTab(safari.application.activeBrowserWindow.activeTab))},create:function(t){var e="undefined"!=typeof t.focused?t.focused:!0;safari.application.activeBrowserWindow.openTab(e?"foreground":"background").url=t.url}}),Browser.prototype=object.extend(BrowserBase,{_onOpen:function(t){if(t.target instanceof SafariBrowserTab){var e=this.getKangoTab(t.target);this.fireEvent(this.event.TAB_CREATED,{target:e,tabId:e.getId()})}},_onClose:function(t){if(t.target instanceof SafariBrowserTab){var e=t.target;this.fireEvent(this.event.TAB_REMOVED,{tabId:this._tabTracker.getId(e)}),this._tabTracker.remove(e)}else t.target instanceof SafariBrowserWindow&&this._windowTracker.remove(t.target)},_onActivate:function(t){if(t.target instanceof SafariBrowserTab){var e=this.getKangoTab(t.target);this.fireEvent(this.event.TAB_CHANGED,{url:e.getUrl(),title:e.getTitle(),target:e,tabId:e.getId()})}else t.target instanceof SafariBrowserWindow&&this.fireEvent(this.event.WINDOW_CHANGED,{target:this.getKangoWindow(t.target)})},_onBeforeNavigate:function(t){var e=this.getKangoTab(t.target);this.fireEvent(this.event.BEFORE_NAVIGATE,{url:t.url||"",target:e})},_onNavigate:function(t){var e=this.getKangoTab(t.target);this.fireEvent(this.event.DOCUMENT_COMPLETE,{url:e.getUrl(),title:e.getTitle(),target:e})},getKangoTab:function(t){var e=this._tabTracker.getId(t);return-1==e&&(e=this._tabTracker.add(t)),new BrowserTab(t,e)},getKangoWindow:function(t){var e=this._windowTracker.getId(t);return-1==e&&(e=this._windowTracker.add(t)),new BrowserWindow(t,e)},getName:function(){return"safari"},windows:{getAll:function(t){t(array.map(safari.application.browserWindows,function(t){return browser.getKangoWindow(t)}))},getCurrent:function(t){t(browser.getKangoWindow(safari.application.activeBrowserWindow))},create:function(t){safari.application.openBrowserWindow().activeTab.url=t.url}}}),BrowserWindow.prototype={getId:function(){return this._id},getTabs:function(t){t(array.map(this._window.tabs,function(t){return browser.getKangoTab(t)}))},getCurrentTab:function(t){t(browser.getKangoTab(this._window.activeTab))},isActive:function(){return safari.application.activeBrowserWindow==this._window}},BrowserTab.prototype={getId:function(){return this._id},getUrl:function(){return this._tab.url||""},getTitle:function(){return this._tab.title||""},getDOMWindow:function(){return null},isActive:function(){return this._tab==this._tab.browserWindow.activeTab},isPrivate:function(){return"undefined"!=typeof safari.application.privateBrowsing?safari.application.privateBrowsing.enabled:!1},navigate:function(t){this._tab.url=t},activate:function(){var t=this._tab.browserWindow;safari.application.activeBrowserWindow!=t&&t.activate(),t.activeTab!=this._tab&&this._tab.activate()},dispatchMessage:function(t,e){return"undefined"!=typeof this._tab.page?(this._tab.page.dispatchMessage(t,e),!0):!1},close:function(){this._tab.close()}};var browser=module.exports=new Browser;module.exports.getPublicApi=getPublicApi,module.exports.BrowserTab=BrowserTab;