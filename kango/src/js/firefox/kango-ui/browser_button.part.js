function BrowserButton(t){BrowserButtonBase.call(this,t);var e=utils.utils.getDomainFromId(extensionInfo.id);this._buttonId="kango-ui-browserButton_"+e,this._popupId="kango-ui-popup_"+e,this._popupFrameId="kango-ui-popup-frame_"+e,this._canvasId="kango-ui-canvas_"+e,this._image=null,this._imageContent=null,this._icon=t.icon||"",this._caption=t.caption||"",this._tooltipText=t.tooltipText||"",this._popupDetails=t.popup||null,this._badgeText="",this._badgeBackgroundColor=this._DEFAULT_BADGE_BACKGROUND_COLOR,this._init()}var extensionInfo=require("kango/extension_info"),utils=require("kango/utils"),object=utils.object,func=utils.func,array=utils.array,chromeWindows=require("kango/chrome_windows"),io=require("kango/io"),systemStorage=require("kango/storage").systemStorage;BrowserButton.prototype=object.extend(BrowserButtonBase,{_DEFAULT_BADGE_BACKGROUND_COLOR:[176,0,18,255],_init:function(){array.forEach(chromeWindows.getLoadedChromeWindows(),function(t){this._addXULElements(t)},this),chromeWindows.addEventListener(chromeWindows.event.WINDOW_LOAD,func.bind(function(t){this._addXULElements(t.window)},this)),chromeWindows.addEventListener(chromeWindows.event.WINDOW_UNLOAD,func.bind(function(t){this._removeXULElements(t.window)},this))},dispose:function(){this.closePopup(),this.removeAllEventListeners(),this._destroyImage(),this._removeCanvas(),array.forEach(chromeWindows.getLoadedChromeWindows(),function(t){this._removeXULElements(t)},this)},_addXULElements:function(t){this._insertPopupPanel(t),this._insertButton(t);var e=func.bind(this._onAfterCustomization,this,t);t.addEventListener("aftercustomization",e,!1),chromeWindows.registerContainerUnloader(function(){t.removeEventListener("aftercustomization",e,!1)},t)},_removeXULElements:function(t){this._removeButton(t),this._removePopupPanel(t)},_onAfterCustomization:function(t,e){var n=this._getButtonElement(t);null!=n&&this._applyButtonProperties(n)},_destroyImage:function(){null!=this._image&&(this._image.onload=null,this._image=null)},_getCanvas:function(){var t=chromeWindows.getHiddenWindow(),e=t.document.getElementById(this._canvasId);return null==e&&(e=t.document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),e.setAttribute("id",this._canvasId)),e},_removeCanvas:function(){var t=chromeWindows.getHiddenWindow(),e=t.document.getElementById(this._canvasId);null!=e&&e.parentNode.removeChild(e)},_getButtonElement:function(t){var e=t.document;return e.getElementById(this._buttonId)},_getBackgroundColor:function(t){return"rgba("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]/255+")"},_applyButtonProperties:function(t){t.setAttribute("label",this._caption),t.setAttribute("tooltiptext",this._tooltipText),t.setAttribute("image",this._imageContent||io.getExtensionFileUrl(this._icon))},_insertButton:function(t){var e=t.document,n=this._buttonId,i=e.createElement("toolbarbutton");i.setAttribute("id",n),i.setAttribute("type","button"),i.setAttribute("removable","true"),i.setAttribute("class","toolbarbutton-1 chromeclass-toolbar-additional"),this._applyButtonProperties(i),i.addEventListener("command",func.bind(this._onCommand,this,e),!1);var o=e.getElementById("navigator-toolbox");o.palette.appendChild(i);var s=e.getElementById("nav-bar"),r=s.getAttribute("currentset").split(","),a=r.indexOf(n);if(-1==a)null==systemStorage.getItem("ui.button_inserted")&&(systemStorage.setItem("ui.button_inserted",!0),s.insertItem(n),s.setAttribute("currentset",s.currentSet),e.persist(s.id,"currentset"));else{var u=null;a+1<r.length&&(u=e.getElementById(r[a+1])),null!=u?s.insertItem(n,u):s.insertItem(n)}},_removeButton:function(t){var e=t.document.getElementById(this._buttonId);null!=e&&e.parentNode.removeChild(e)},_insertPopupPanel:function(t){var e=t.document,n=e.getElementsByTagName("popupset")[0],i=e.createElement("panel");i.setAttribute("id",this._popupId),i.setAttribute("type","arrow"),i.setAttribute("level","top"),i.setAttribute("consumeoutsideclicks","true");var o=".panel-arrowcontent {background-color: white; padding: 0}",s="chrome://global/content/bindings/popup.xml#arrowpanel",r='<bindings xmlns="http://www.mozilla.org/xbl"><binding id="id" extends="'+s+'"><resources><stylesheet src="data:text/css;charset=utf-8,'+t.encodeURIComponent(o)+'"/></resources></binding></bindings>';i.style.MozBinding='url("data:text/xml;charset=utf-8,'+t.encodeURIComponent(r)+'")';var a=e.createElement("iframe");a.setAttribute("id",this._popupFrameId),a.setAttribute("flex","1"),a.setAttribute("transparent","transparent"),a.addEventListener("DOMContentLoaded",func.bind(function(t){var e=t.target.defaultView.wrappedJSObject;e.__kango_require=require,this.fireEvent(this.event.POPUP_DOCUMENT_COMPLETE,{window:e})},this),!0),i.appendChild(a),i.addEventListener("popuphidden",function(){a.setAttribute("src","about:blank")},!0),n.appendChild(i)},_removePopupPanel:function(t){var e=t.document,n=e.getElementById(this._popupId);null!=n&&n.parentNode.removeChild(n)},_onCommand:function(t,e){var n=e.target;if(n.id==this._buttonId)if(null!=this._popupDetails){var i=t.getElementById(this._popupId),o=this._popupDetails.url;0!=o.indexOf("http")&&(o=io.getExtensionFileUrl(o));var s=t.getElementById(this._popupFrameId);s.style.width=this._popupDetails.width+"px",s.style.height=this._popupDetails.height+"px",s.setAttribute("src",o),i.openPopup(n,"bottomcenter topright",0,0,!1,null)}else this.fireEvent(this.event.COMMAND)},_updateEachButtonImage:function(){this._updateImage(func.bind(function(){this._forEachButton(func.bind(function(t){t.image=this._imageContent},this))},this))},_forEachButton:function(t){array.forEach(chromeWindows.getLoadedChromeWindows(),function(e){var n=this._getButtonElement(e);null!=n&&t(n,e)},this)},_updateImage:function(t){var e=function(t,e,n,i,o,s,r){t.beginPath(),t.moveTo(e,n+s),t.lineTo(e,n+o-s),t.quadraticCurveTo(e,n+o,e+s,n+o),t.lineTo(e+i-s,n+o),t.quadraticCurveTo(e+i,n+o,e+i,n+o-s),t.lineTo(e+i,n+s),t.quadraticCurveTo(e+i,n,e+i-s,n),t.lineTo(e+s,n),t.quadraticCurveTo(e,n,e,n+s),t.fillStyle=r,t.fill()};this._destroyImage();var n=chromeWindows.getHiddenWindow(),i=this._image=new n.Image;i.onload=func.bind(function(){var n=-4,o=i.width,s=i.height;(o>19||s>19)&&(o=s=19);var r=this._getCanvas(),a=r.getContext("2d");if(""!=this._badgeText){var u=11,d="bold "+u+"px Tahoma,arial,helvetica,sans-serif";a.font=d,r.width=19,r.height=19;var l=Math.round(a.measureText(this._badgeText).width);r.width=o+l+2,r.height=s,a.drawImage(i,0,0,o,s);var h=this._getBackgroundColor(this._badgeBackgroundColor);e(a,o+n,s-u-1,l+6,u+1,4,h),a.font=d,a.textBaseline="top",a.fillStyle="white",a.fillText(this._badgeText,o+n+2,s-u)}else r.width=o,r.height=s,a.drawImage(i,0,0,o,s);this._imageContent=r.toDataURL("image/png"),i.onload=null,t()},this),i.src=io.getExtensionFileUrl(this._icon)},_setTooltipText:function(t,e){t.setAttribute("tooltiptext",e)},_setCaption:function(t,e){t.setAttribute("label",e)},_setContextMenu:function(t,e,n,i){var o=e.document,s=o.createElement("menupopup"),r=t.id+"-menu";s.setAttribute("id",r),t.appendChild(s);var a=o.createElement("menuitem");a.setAttribute("label",n),a.addEventListener("command",function(t){i(),t.preventDefault()},!1),s.appendChild(a),t.addEventListener("contextmenu",function(e){s.openPopup(t,"after_start",0,0,!0,!1),e.preventDefault()},!1)},resizePopup:function(t,e){var n=chromeWindows.getMostRecentChromeWindow();if(null!=n){var i=n.document.getElementById(this._popupFrameId);n.document.getElementById(this._popupId);i.style.width=t+"px",i.style.height=e+"px"}},setTooltipText:function(t){this._tooltipText=t,this._forEachButton(func.bind(function(e){this._setTooltipText(e,t)},this))},setCaption:function(t){this._caption=t,this._forEachButton(func.bind(function(e){this._setCaption(e,t)},this))},setIcon:function(t){""!=t&&null!=t?this._icon!=t&&(this._icon=t,this._updateEachButtonImage()):this._forEachButton(func.bind(function(t){t.removeAttribute("image")},this))},setBadgeValue:function(t){var e=null!=t&&0!=t?t.toString():"";this._badgeText!=e&&(this._badgeText=e,this._updateEachButtonImage())},setBadgeBackgroundColor:function(t){null!=t&&object.isArray(t)&&t.length>=4&&(this._badgeBackgroundColor=t,this._updateEachButtonImage())},setPopup:function(t){this._popupDetails=t},closePopup:function(){var t=chromeWindows.getMostRecentChromeWindow();if(null!=t){var e=t.document.getElementById(this._popupId);null!=e&&e.hidePopup()}},setContextMenu:function(t,e){this._forEachButton(func.bind(function(n,i){this._setContextMenu(n,i,t,e)},this))}}),extensionInfo.browser_button&&(module.exports=new BrowserButton(extensionInfo.browser_button),module.exports.getPublicApi=getPublicApi);